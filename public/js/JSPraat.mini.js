var JSPraat={};JSPraat.TextGrid=function(d){if(!(this instanceof JSPraat.TextGrid)){return new JSPraat.TextGrid(d)}var c=/^.+\.TextGrid$/i;var b;var a=this;this.readyFunc=null;if((b=d.match(c))){$.ajax({url:d}).done(function(e){a.initializeFromData(e)})}else{this.initializeFromData(d)}};JSPraat.TextGrid.prototype.initializeFromData=function(a){this.lines=a.split("\n");this.header={fileType:null,objectClass:null,xmin:null,xmax:null,tiersExist:false,numberOfTiers:0};this.startingLineIndexOfTiers=-1;this.tiers=[];this.parseHeader();this.checkHeader();this.parseTiers();if(typeof this.readyFunc==="function"){this.readyFunc()}};JSPraat.TextGrid.prototype.ready=function(a){if(typeof a!=="function"){throw"TextGrid ready requires a function"}this.readyFunc=a};JSPraat.TextGrid.prototype.checkHeader=function(){if(this.tiersExist===false){throw"Invalid TextGrid Header: Tiers do not exist"}if(this.startingLineIndexOfTiers<0){throw"Invalid TextGrid Header: startingLineIndexOfTiers Not Found"}};JSPraat.TextGrid.prototype.parseTiers=function(){var b=/^\s+item\s+\[(\d+)\]\:/i;var a;var d=null;var f=0;var e=0;for(var c=this.startingLineIndexOfTiers;c<this.lines.length;c++){if((a=this.lines[c].match(b))){if(d>0){this.tiers.push(new JSPraat.TextGrid.Tier(this.lines.slice(f,e)))}d=parseInt(a[1]);f=c+1;e=c+1}if(d>0){e++}}this.tiers.push(new JSPraat.TextGrid.Tier(this.lines.slice(f,e)))};JSPraat.TextGrid.prototype.parseHeader=function(){var g=/^\s*item\s*\[.+\]\:/i;var j=/^xmin\s*=\s*([\d\.]+)/i;var e=/^xmax\s*=\s*([\d\.]+)/i;var h=/^tiers\?\s*(<exists>)/i;var a=/^size\s*=\s*(\d+)/;var c=/^File type\s*=\s*\"(\w+)\"/i;var b=/^Object class\s*=\s*\"(\w+)\"/i;var f;for(var d=0;d<this.lines.length;d++){if(this.lines[d].match(g)){this.startingLineIndexOfTiers=d;break}if((f=this.lines[d].match(j))){this.header.xmin=parseFloat(f[1])}else{if((f=this.lines[d].match(e))){this.header.xmax=parseFloat(f[1])}else{if((f=this.lines[d].match(h))){this.header.tiersExist=true}else{if((f=this.lines[d].match(a))){this.header.numberOfTiers=parseInt(f[1])}else{if((f=this.lines[d].match(c))){this.header.fileType=f[1]}else{if((f=this.lines[d].match(b))){this.header.objectClass=f[1]}}}}}}}};JSPraat.TextGrid.Tier=function(a){if(!(this instanceof JSPraat.TextGrid.Tier)){return new JSPraat.TextGrid.Tier(a)}this.lines=a;this.lines.pop();this.header={classname:null,name:null,xmin:null,xmax:null,numberOfIntervals:null,numberOfPoints:null};this.startingLineIndexOfBody=null;this.parseHeader();this.checkHeader();if(this.header.classname==="IntervalTier"){this.intervals=[];this.parseIntervals()}else{if(this.header.classname==="TextTier"){this.points=[];this.parsePoints()}else{throw"Invalid Tier Header: "+this.header.classname+" is not an acceptable classname"}}};JSPraat.TextGrid.Tier.prototype.checkHeader=function(){if(!this.header.classname){throw"Invalid Tier Header: classname is missing"}if(!this.header.name){throw"Invalid Tier Header: name is missing"}if(!this.header.xmin){throw"Invalid Tier Header: xmin is missing"}if(!this.header.xmax){throw"Invalid Tier Header: xmax is missing"}if(this.header.numberOfIntervals===null&&this.header.numberOfPoints===null){throw"Invalid Tier Header: not an interval or point tier."}if(this.isIntervalTier()&&this.header.numberOfIntervals===null){throw"Invalid Tier Header: classname mismatch. says interval tier but has points size"}if(this.isPointTier()&&this.header.numberOfPoints===null){throw"Invalid Tier Header: classname mismatch. says point tier but has intervals size"}if(this.header.numberOfPoints!==null&&this.header.numberOfIntervals!==null){throw"Invalid Tier Header: header cannot contain both points size and intervals size"}};JSPraat.TextGrid.Tier.prototype.isIntervalTier=function(){if(this.header.classname==="IntervalTier"){return true}return false};JSPraat.TextGrid.Tier.prototype.isPointTier=function(){if(this.header.classname==="TextTier"){return true}return false};JSPraat.TextGrid.Tier.prototype.parseHeader=function(){var a=/^\s+class\s*=\s*\"(\w+)\"/i;var h=/^\s+name\s*=\s*\"(\w+)\"/i;var g=/^\s+xmin\s*=\s*([\d\.]+)/i;var d=/^\s+xmax\s*=\s*([\d\.]+)/i;var b=/^\s+intervals\:\s*size\s*=\s*(\d+)/i;var f=/^\s+points\:\s*size\s*=\s*(\d+)/i;var j=/^(\s+)/;var e;var k=false;var l=null;for(var c=0;c<this.lines.length;c++){if((e=this.lines[c].match(b))){this.header.numberOfIntervals=l=parseInt(e[1]);k=true;this.startingLineIndexOfBody=c+1;break}if((e=this.lines[c].match(f))){this.header.numberOfPoints=l=parseInt(e[1]);k=true;this.startingLineIndexOfBody=c+1;break}else{if((e=this.lines[c].match(a))){this.header.classname=e[1]}else{if((e=this.lines[c].match(h))){this.header.name=e[1]}else{if((e=this.lines[c].match(g))){this.header.xmin=e[1]}else{if((e=this.lines[c].match(d))){this.header.xmax=e[1]}}}}}}if(!k&&l>0){throw"Invalid Tier Header: end condition not reached while size is non-zero"}};JSPraat.TextGrid.Tier.prototype.parseIntervals=function(){if(this.header.numberOfIntervals===0){return}var d=this.startingLineIndexOfBody;var b,a,e,j;var h=/^\s*intervals\s*\[\d+\]\:/i;var f=/^\s*xmax\s*\=\s*([\d\.]+)/i;var g=/^\s*xmin\s*\=\s*([\d\.]+)/i;var c=/^\s*text\s*\=\s*\"(.*)\"/i;while(d<this.lines.length){b=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 0"}a=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 1"}e=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 2"}j=this.lines[d++];if((match=b.match(h))){}else{throw"Invalid Tier Body: Invalid interval start format, expecting 'intervals [<digit>]:'"}if((match=e.match(f))){e=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'xmax' format"}if((match=a.match(g))){a=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'xmin' format"}if((match=j.match(c))){j=match[1]}else{throw"Invalid Tier Body: Invalid 'text' format"}this.intervals.push([a,e,j])}if(d<this.lines.length){throw"Invalid Tier Body: incomplete interval remains"}};JSPraat.TextGrid.Tier.prototype.parsePoints=function(){if(this.header.numberOfPoints===0){return}var f=/\s*points\s*\[\d+\]\:/i;var e=/^\s*number\s*\=\s*([\d\.]+)/i;var d=/^\s*mark\s*\=\s*\"(.*)\"/i;var b,c,g;for(var a=this.startingLineIndexOfBody;a<this.lines.length;a++){b=this.lines[a++];if(a>=this.lines.length){throw"Invalid Tier Body: incomplete point 0"}c=this.lines[a++];if(a>=this.lines.length){throw"Invalid Tier Body: incomplete point 1"}g=this.lines[a++];if((match=b.match(f))){}else{throw"Invalid Tier Body: Invalid point start format, expecting 'points [<digit>]:'"}if((match=c.match(e))){c=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'number' format"}if((match=g.match(d))){g=match[1]}else{throw"Invalid Tier Body: Invalid 'mark' format"}this.points.push([c,g])}};JSPraat.Audio=function(b){if(!(this instanceof JSPraat.Audio)){return new JSPraat.Audio.Audio(b)}console.log("constructing JSPraat.Audio...");var a=this;this.url=b;this.ctx=new AudioContext();this.analyserNode=this.ctx.createAnalyser();this.analyserNode.smoothingTimeConstant=0.3;this.analyserNode.fftSize=1024;this.audioBuffer=null;this.sourceNode=null;this.gainNode=null;this.gainValue=1;this.loadSound();window.maudio=this;console.log("constructing JSPraat.Audio...done")};JSPraat.Audio.prototype.initNodes=function(){console.log("initNodes...");this.sourceNode=this.ctx.createBufferSource();this.sourceNode.buffer=this.audioBuffer;console.log("sourceNode = ",this.sourceNode);this.gainNode=this.ctx.createGain();this.gainNode.connect(this.ctx.destination);this.gainNode.gain.value=this.gainValue;console.log("gainNode = ",this.gainNode);this.sourceNode.connect(this.gainNode);this.sourceNode.connect(this.analyserNode);console.log("initNodes...done")};JSPraat.Audio.prototype.loadSound=function(){console.log("loading sound from: "+this.url);var a=this;var b=new XMLHttpRequest();b.open("GET",this.url,true);b.responseType="arraybuffer";b.onload=function(){a.ctx.decodeAudioData(b.response,function(c){a.audioBuffer=c;a.initNodes()},a.onError)};b.send()};JSPraat.Audio.prototype.playSound=function(b,a){console.log("playing sound ["+b+", "+a+"]");this.sourceNode.noteOn(this.ctx.currentTime+b);if(a){this.sourceNode.noteOff(this.ctx.currentTime+a)}this.initNodes()};JSPraat.Audio.prototype.onError=function(a){console.log(a);throw"Audio: error decoding audio data. "};JSPraat.TimeSyncedGrid=function(a){if(!(this instanceof JSPraat.TimeSyncedGrid)){return new JSPraat.TimeSyncedGrid(a)}if(!(a instanceof jQuery)){throw"TimeSyncedGrid: container must be a jQuery object"}if(a.length==0){throw"TimeSyncedGrid: container does not exist"}this.zoomFactor=20;this.xmultMin=100;this.xmultMax=800;this.xmult=this.xmultMin+(this.xmultMax-this.xmultMin)/2;this.timePrecision=3;this.cPrefix="TSG";this.currentTime=0;this.currentTimeMarkerPosition=null;this.tierNameOffset=null;this.c={width:null,height:null,"$":a,scroller:{cn:this.cPrefix+"-scroller","$":null,pos:0},infotop:{cn:this.cPrefix+"-infotop","$":null,timeData:{cn:this.cPrefix+"-infotop-time-data","$":null},label:{cn:this.cPrefix+"-infotop-label","$":null},currentTime:{cn:this.cPrefix+"-current-time","$":null},controls:{cn:this.cPrefix+"-controls","$":null,zoomIn:{cn:this.cPrefix+"-controls-zoom-in","$":null},zoomOut:{cn:this.cPrefix+"-controls-zoom-out","$":null},zoomSlider:{cn:this.cPrefix+"-controls-zoom-slider","$":null},zoomIndicator:{cn:this.cPrefix+"-controls-zoom-indicator","$":null}}},tiers:{className:this.cPrefix+"-tier",s:"."+this.cPrefix+"-tier",nfo:{}}};this.initializeUI();this.textgrid=null;this.audio=null};JSPraat.TimeSyncedGrid.prototype.initializeUI=function(){var a=this;this.c.$.html("<div class='"+this.c.scroller.cn+"'></div>");this.c.scroller.$=this.c.$.find("."+this.c.scroller.cn);this.c.$.prepend("<div class='"+this.c.infotop.cn+"'></div>");this.c.infotop.$=this.c.$.find("."+this.c.infotop.cn);this.c.infotop.$.prepend("<span class='"+this.c.infotop.label.cn+"'></span>");this.c.infotop.label.$=this.c.infotop.$.find("."+this.c.infotop.label.cn);this.c.infotop.$.prepend("<span class='"+this.c.infotop.timeData.cn+"'></span>");this.c.infotop.timeData.$=this.c.infotop.$.find("."+this.c.infotop.timeData.cn);this.c.infotop.$.append("<span class='"+this.c.infotop.currentTime.cn+"'></span>");this.c.infotop.currentTime.$=this.c.infotop.$.find("."+this.c.infotop.currentTime.cn);this.c.infotop.currentTime.$.text("-");this.c.infotop.$.prepend("<span class='"+this.c.infotop.controls.cn+"'></span>");this.c.infotop.controls.$=this.c.infotop.$.find("."+this.c.infotop.controls.cn);this.c.infotop.controls.$.append("<span class='control-btn "+this.c.infotop.controls.zoomIn.ID+"' data-name='zoomIn'><i class='fa fa-fw fa-search-plus'></i></span>");this.c.infotop.controls.zoomIn.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomIn.cn);this.c.infotop.controls.$.append("<span class='control-btn "+this.c.infotop.controls.zoomOut.ID+"' data-name='zoomOut'><i class='fa fa-fw fa-search-minus'></i></span>");this.c.infotop.controls.zoomOut.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomOut.cn);this.c.infotop.controls.$.append('<input type="range" name="points" min="'+this.xmultMin+'" max="'+this.xmultMax+'" class="'+this.c.infotop.controls.zoomSlider.cn+'">');this.c.infotop.controls.zoomSlider.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomSlider.cn);this.c.infotop.controls.zoomSlider.$.on("change",function(b){a.xmult=parseInt($(this).val());a.render()});this.c.infotop.controls.$.append('<span class="'+this.c.infotop.controls.zoomIndicator.cn+'">'+this.xmult+"</span>");this.c.infotop.controls.zoomIndicator.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomIndicator.cn);this.c.scroller.$.on("scroll",function(d){if(!a.tierNameOffset){return}var b=$(this).scrollLeft();var f=a.c.scroller.$.find(".tier-name-floater");f.animate({opacity:((b>a.tierNameOffset)?1:0)},200);for(var c in a.c.tiers.nfo){a.c.tiers.nfo[c].nameFloater.transition().duration(700).attr("transform","translate("+b+", 0)")}});this.c.infotop.controls.$.find(".control-btn").each(function(b){$(this).on("click",function(f){var c=$(this).data("name");var d=a["controlsEventHandler_"+c+"_click"];if(typeof d!=="function"){return}d.call(a,f)})});this.updateZoomControls()};JSPraat.TimeSyncedGrid.prototype.updateZoomControls=function(){this.c.infotop.controls.zoomIndicator.$.text(Math.round((this.xmult-this.xmultMin)/(this.xmultMax-this.xmultMin)*100));this.c.infotop.controls.zoomSlider.$.val(this.xmult)};JSPraat.TimeSyncedGrid.prototype.controlsEventHandler_zoomIn_click=function(a){console.log("TimeSyncedGrid Event: zoomIn");this.xmult+=this.zoomFactor;this.render()};JSPraat.TimeSyncedGrid.prototype.controlsEventHandler_zoomOut_click=function(b){console.log("TimeSyncedGrid Event: zoomOut");var a=this.xmult-this.zoomFactor;if(a<this.xmultMin){return}this.xmult=a;this.render()};JSPraat.TimeSyncedGrid.prototype.setTextGrid=function(a){this.textgrid=a;this.render()};JSPraat.TimeSyncedGrid.prototype.render=function(){this.c.width=this.c.$.innerWidth();this.c.height=this.c.$.innerHeight();var d=0;var c=0;var b=0;for(var a in this.c.tiers.nfo){d=$(this.c.tiers.nfo[a].timeMarker[0][0]).offset().left;break}this.c.scroller.pos=this.c.scroller.$.scrollLeft();this.c.scroller.$.html("");if(this.textgrid){this.renderTextGrid()}if(this.audio){this.renderAudio()}this.c.scroller.$.scrollLeft(this.c.scroller.pos);this.updateZoomControls();this.updateTimeMarker();c=$(this.c.tiers.nfo[Object.keys(this.c.tiers.nfo)[0]].timeMarker[0][0]).offset().left;b=c-d;if(d){this.c.scroller.$.scrollLeft(this.c.scroller.pos+b)}};JSPraat.TimeSyncedGrid.prototype.renderTextGrid=function(){console.log("rendering textgrid");var q=this;var l=Math.ceil(q.textgrid.header.xmax);var p=null;if(this.textgrid===null){throw"TimeSyncedGrid: renderTextGrid found no textgrid"}this.xmin=this.textgrid.header.xmin;this.xmax=this.textgrid.header.xmax;var n=d3.select(this.c.scroller.$.get(0)).selectAll("div").data(this.textgrid.tiers).enter().append("div").attr("class",function(i){return q.c.tiers.className+" "+(i.isIntervalTier()?"interval-tier":"point-tier")}).attr("data-height",function(i){return $(this).height()}).append("svg").attr("height",function(){return(p=$(this).parent().height())}).attr("width",function(){return q.xmult*l});var j=p/2;var k=n[0];var h=0;for(var d=0;d<k.length;d++){var a=k[d].__data__.header.name;if(a.length>h){h=a.length}}h*=10;for(var d=0;d<k.length;d++){var g=k[d];var c=g.__data__;var f=d3.select(g);var m=f.append("rect").attr("height",j).attr("width",h).attr("x",0).attr("y",j/2).attr("class","tier-name-box").attr("title",c.header.name);var e=f.append("text").attr("height",j).attr("width",h).attr("x",0).attr("y",j/2).attr("dy",j/1.5).attr("dx",2).attr("class","tier-name-text").text(c.header.name);var b=null;if(c.isIntervalTier()){b=f.selectAll("g").data(c.intervals).enter().append("g").attr("transform",function(s,r){return"translate("+(h+q.xmult*s[0])+", "+(j/2)+")"}).attr("width",function(i){return(q.xmult*i[1])-(q.xmult*i[0])-1}).attr("height",j).attr("class","interval-group").on("mouseenter",function(i){q.c.infotop.timeData.$.text(i[0].toFixed(q.timePrecision)+", "+i[1].toFixed(q.timePrecision));q.c.infotop.label.$.html(i[2])}).on("mouseout",function(i){});b.append("rect").attr("height",j).attr("width",function(i){return(q.xmult*i[1])-(q.xmult*i[0])-1}).attr("x",0).attr("y",0).attr("class","interval-box").attr("title",function(i){return i[2]});b.append("text").attr("x",0).attr("y",0).attr("dy",j/1.5).attr("dx",2).text(function(i){var r=$(this).prev();if((i[2].length*10)>=parseInt(r.attr("width"))){r.attr("class","interval-box-too-small");return""}return i[2]}).attr("class","tier-text")}if(c.isPointTier()){b=f.selectAll("g").data(c.points).enter().append("g").attr("transform",function(s,r){return"translate("+(h+q.xmult*s[0])+", "+(j/2)+")"}).attr("width",5).attr("height",j).attr("class","point-group").on("mouseenter",function(i){q.c.infotop.timeData.$.text(i[0].toFixed(q.timePrecision));q.c.infotop.label.$.text(i[1])}).on("mouseout",function(i){});b.append("rect").attr("height",j).attr("width",function(i){return 10*i[1].length}).attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("class","point-box");b.append("text").attr("x",0).attr("y",0).attr("dy",j/1.5).attr("dx",2).text(function(i){var r=$(this).prev();if((i[1].length*10)>parseInt(r.attr("width"))){r.attr("class","interval-box-too-small");return""}return i[1]}).attr("class","tier-text")}var o=f.append("rect").attr("width",1).attr("height",p).attr("x",q.currentTimeMarkerPosition).attr("y",0).attr("class","current-time-marker");tierFloaterGroup=f.append("g").attr("transform","translate("+0+","+0+")").attr("width",h).attr("height",j/2).attr("class","tier-name-floater");tierFloaterGroup.append("rect").attr("width",h).attr("height",j/2);tierFloaterGroup.append("text").attr("x",0).attr("y",0).attr("dy",j/2.5).attr("dx",2).attr("class","tier-name-floater-text").text(c.header.name);f.attr("data-tier-name",c.header.name);q.c.tiers.nfo[c.header.name]={timeMarker:o,nameFloater:tierFloaterGroup}}q.c.tiers.tierNameOffset=h;q.c.scroller.$.find("svg").on("click",function(r){var i=q.c.scroller.$.scrollLeft()+(r.pageX-q.c.scroller.$.position().left)-h-1;if(i<0){i=0}q.currentTime=i/q.xmult;console.log(i,q.currentTime);q.c.infotop.currentTime.$.text(q.currentTime.toFixed(q.timePrecision));q.updateTimeMarker()});q.tierNameOffset=h};JSPraat.TimeSyncedGrid.prototype.updateTimeMarker=function(){var b=this;b.currentTimeMarkerPosition=b.currentTime*b.xmult+b.c.tiers.tierNameOffset;for(var a in b.c.tiers.nfo){var c=b.c.tiers.nfo[a].timeMarker;c.attr("x",b.currentTimeMarkerPosition)}this.c.infotop.currentTime.$.text(this.currentTime.toFixed(this.timePrecision))};JSPraat.TimeSyncedGrid.prototype.renderAudio=function(){console.log("rendering Audio");if(this.audiofile===null){throw"TimeSyncedGrid: renderAudio found no audio"}};JSPraat.TimeSyncedGrid.autoRender=function(){$(".TSG-container").each(function(f){var d=$(this);var b=d.data("textgrid");var g=d.data("audio");var a=new JSPraat.TimeSyncedGrid(d);var c=new JSPraat.TextGrid(b);c.ready(function(){a.setTextGrid(c)})})};