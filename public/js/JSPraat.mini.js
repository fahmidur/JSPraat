var JSPraat={};JSPraat.TextGrid=function(d,e){if(!(this instanceof JSPraat.TextGrid)){return new JSPraat.TextGrid(d)}var c=/^.+\.TextGrid$/i;var b;var a=this;this.readyFunc=e;if((b=d.match(c))){$.ajax({url:d}).done(function(f){a.initializeFromData(f)})}else{this.initializeFromData(d)}};JSPraat.TextGrid.prototype.initializeFromData=function(a){this.lines=a.split("\n");this.header={fileType:null,objectClass:null,xmin:null,xmax:null,tiersExist:false,numberOfTiers:0};this.startingLineIndexOfTiers=-1;this.tiers=[];this.parseHeader();this.checkHeader();this.parseTiers();if(typeof this.readyFunc==="function"){this.readyFunc()}};JSPraat.TextGrid.prototype.ready=function(a){if(typeof a!=="function"){throw"TextGrid ready requires a function"}this.readyFunc=a};JSPraat.TextGrid.prototype.checkHeader=function(){if(this.tiersExist===false){throw"Invalid TextGrid Header: Tiers do not exist"}if(this.startingLineIndexOfTiers<0){throw"Invalid TextGrid Header: startingLineIndexOfTiers Not Found"}};JSPraat.TextGrid.prototype.parseTiers=function(){var b=/^\s+item\s+\[(\d+)\]\:/i;var a;var d=null;var f=0;var e=0;for(var c=this.startingLineIndexOfTiers;c<this.lines.length;c++){if((a=this.lines[c].match(b))){if(d>0){this.tiers.push(new JSPraat.TextGrid.Tier(this.lines.slice(f,e)))}d=parseInt(a[1]);f=c+1;e=c+1}if(d>0){e++}}this.tiers.push(new JSPraat.TextGrid.Tier(this.lines.slice(f,e)))};JSPraat.TextGrid.prototype.parseHeader=function(){var g=/^\s*item\s*\[.+\]\:/i;var j=/^xmin\s*=\s*([\d\.]+)/i;var e=/^xmax\s*=\s*([\d\.]+)/i;var h=/^tiers\?\s*(<exists>)/i;var a=/^size\s*=\s*(\d+)/;var c=/^File type\s*=\s*\"(\w+)\"/i;var b=/^Object class\s*=\s*\"(\w+)\"/i;var f;for(var d=0;d<this.lines.length;d++){if(this.lines[d].match(g)){this.startingLineIndexOfTiers=d;break}if((f=this.lines[d].match(j))){this.header.xmin=parseFloat(f[1])}else{if((f=this.lines[d].match(e))){this.header.xmax=parseFloat(f[1])}else{if((f=this.lines[d].match(h))){this.header.tiersExist=true}else{if((f=this.lines[d].match(a))){this.header.numberOfTiers=parseInt(f[1])}else{if((f=this.lines[d].match(c))){this.header.fileType=f[1]}else{if((f=this.lines[d].match(b))){this.header.objectClass=f[1]}}}}}}}};JSPraat.TextGrid.Tier=function(a){if(!(this instanceof JSPraat.TextGrid.Tier)){return new JSPraat.TextGrid.Tier(a)}this.lines=a;this.lines.pop();this.header={classname:null,name:null,xmin:null,xmax:null,numberOfIntervals:null,numberOfPoints:null};this.startingLineIndexOfBody=null;this.parseHeader();this.checkHeader();if(this.header.classname==="IntervalTier"){this.intervals=[];this.parseIntervals()}else{if(this.header.classname==="TextTier"){this.points=[];this.parsePoints()}else{throw"Invalid Tier Header: "+this.header.classname+" is not an acceptable classname"}}};JSPraat.TextGrid.Tier.prototype.checkHeader=function(){if(!this.header.classname){throw"Invalid Tier Header: classname is missing"}if(!this.header.name){throw"Invalid Tier Header: name is missing"}if(!this.header.xmin){throw"Invalid Tier Header: xmin is missing"}if(!this.header.xmax){throw"Invalid Tier Header: xmax is missing"}if(this.header.numberOfIntervals===null&&this.header.numberOfPoints===null){throw"Invalid Tier Header: not an interval or point tier."}if(this.isIntervalTier()&&this.header.numberOfIntervals===null){throw"Invalid Tier Header: classname mismatch. says interval tier but has points size"}if(this.isPointTier()&&this.header.numberOfPoints===null){throw"Invalid Tier Header: classname mismatch. says point tier but has intervals size"}if(this.header.numberOfPoints!==null&&this.header.numberOfIntervals!==null){throw"Invalid Tier Header: header cannot contain both points size and intervals size"}};JSPraat.TextGrid.Tier.prototype.isIntervalTier=function(){if(this.header.classname==="IntervalTier"){return true}return false};JSPraat.TextGrid.Tier.prototype.isPointTier=function(){if(this.header.classname==="TextTier"){return true}return false};JSPraat.TextGrid.Tier.prototype.parseHeader=function(){var a=/^\s+class\s*=\s*\"(\w+)\"/i;var h=/^\s+name\s*=\s*\"(\w+)\"/i;var g=/^\s+xmin\s*=\s*([\d\.]+)/i;var d=/^\s+xmax\s*=\s*([\d\.]+)/i;var b=/^\s+intervals\:\s*size\s*=\s*(\d+)/i;var f=/^\s+points\:\s*size\s*=\s*(\d+)/i;var j=/^(\s+)/;var e;var k=false;var l=null;for(var c=0;c<this.lines.length;c++){if((e=this.lines[c].match(b))){this.header.numberOfIntervals=l=parseInt(e[1]);k=true;this.startingLineIndexOfBody=c+1;break}if((e=this.lines[c].match(f))){this.header.numberOfPoints=l=parseInt(e[1]);k=true;this.startingLineIndexOfBody=c+1;break}else{if((e=this.lines[c].match(a))){this.header.classname=e[1]}else{if((e=this.lines[c].match(h))){this.header.name=e[1]}else{if((e=this.lines[c].match(g))){this.header.xmin=e[1]}else{if((e=this.lines[c].match(d))){this.header.xmax=e[1]}}}}}}if(!k&&l>0){throw"Invalid Tier Header: end condition not reached while size is non-zero"}};JSPraat.TextGrid.Tier.prototype.parseIntervals=function(){if(this.header.numberOfIntervals===0){return}var d=this.startingLineIndexOfBody;var b,a,e,j;var h=/^\s*intervals\s*\[\d+\]\:/i;var f=/^\s*xmax\s*\=\s*([\d\.]+)/i;var g=/^\s*xmin\s*\=\s*([\d\.]+)/i;var c=/^\s*text\s*\=\s*\"(.*)\"/i;while(d<this.lines.length){b=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 0"}a=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 1"}e=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 2"}j=this.lines[d++];if((match=b.match(h))){}else{throw"Invalid Tier Body: Invalid interval start format, expecting 'intervals [<digit>]:' \n "}if((match=e.match(f))){e=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'xmax' format"}if((match=a.match(g))){a=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'xmin' format"}if((match=j.match(c))){j=match[1]}else{throw"Invalid Tier Body: Invalid 'text' format"}this.intervals.push([a,e,j])}if(d<this.lines.length){throw"Invalid Tier Body: incomplete interval remains"}};JSPraat.TextGrid.Tier.prototype.parsePoints=function(){if(this.header.numberOfPoints===0){return}var f=/\s*points\s*\[\d+\]\:/i;var e=/^\s*\w+\s*\=\s*([\d\.]+)/i;var d=/^\s*\w+\s*\=\s*\"(.*)\"/i;var b,c,g;for(var a=this.startingLineIndexOfBody;a<this.lines.length;a++){b=this.lines[a++];if(a>=this.lines.length){throw"Invalid Tier Body: incomplete point 0"}c=this.lines[a++];if(a>=this.lines.length){throw"Invalid Tier Body: incomplete point 1"}g=this.lines[a];if((match=b.match(f))){}else{throw"Invalid Tier Body: Invalid point start format, expecting 'points [<digit>]:'"+b+"|"}if((match=c.match(e))){c=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'number' format"}if((match=g.match(d))){g=match[1]}else{throw"Invalid Tier Body: Invalid 'mark' format"}this.points.push([c,g])}};JSPraat.Audio=function(b,c){if(!(this instanceof JSPraat.Audio)){return new JSPraat.Audio.Audio(b)}console.log("constructing JSPraat.Audio...");var a=this;this.url=b;this.readyFunc=c;this.ctx=new AudioContext();this.audioBuffer=c;this.sourceNode=null;this.channelData=new Array();this.gainNode=null;this.gainValue=1;this.analyserNode=null;this.jsNode=null;this.loadSound();console.log("constructing JSPraat.Audio...done")};JSPraat.Audio.getAverageVolume=function(a){var d=0;var c=a.length;for(var b=0;b<c;b++){d+=a[b];d/=2}return d};JSPraat.Audio.prototype.findPeaks=function(c){var m=new Float32Array(c);var d=this.audioBuffer.length/c;var h=Math.floor(h/10)||1;for(var a=0;a<this.audioBuffer.numberOfChannels;++a){var g=this.channelData[a];for(var k=0;k<c;++k){var b=Math.floor(k*d);var e=Math.floor(b+d);var l=0;for(var f=b;f<e;f+=h){var n=g[f];if(n>l){l=n}else{if(-n>l){l=n}}}if(a==0||l>m[k]){m[k]=l}}}return m};JSPraat.Audio.prototype.ready=function(a){if(typeof a!=="function"){throw"Audio: ready requires a function"}this.readyFunc=a};JSPraat.Audio.prototype.initNodes=function(){var a=this;console.log("initNodes...");this.sourceNode=this.ctx.createBufferSource();this.sourceNode.buffer=this.audioBuffer;this.playingTimeout=null;console.log("sourceNode = ",this.sourceNode);this.gainNode=this.ctx.createGain();this.gainNode.connect(this.ctx.destination);this.gainNode.gain.value=this.gainValue;console.log("gainNode = ",this.gainNode);this.analyserNode=this.ctx.createAnalyser();this.analyserNode.smoothingTimeConstant=0.3;this.analyserNode.fftSize=1024;this.jsNode=this.ctx.createScriptProcessor(2048,2,1);console.log("jsNode = ",this.jsNode);this.connectNodes();console.log("initNodes...done")};JSPraat.Audio.prototype.connectNodes=function(){this.sourceNode.connect(this.gainNode);this.sourceNode.connect(this.analyserNode);this.analyserNode.connect(this.jsNode);this.jsNode.connect(this.ctx.destination)};JSPraat.Audio.prototype.loadSound=function(){console.log("loading sound from: "+this.url);var a=this;var b=new XMLHttpRequest();b.open("GET",this.url,true);b.responseType="arraybuffer";b.onload=function(){a.ctx.decodeAudioData(b.response,function(c){a.audioBuffer=c;a.initNodes();for(var d=0;d<a.audioBuffer.numberOfChannels;++d){a.channelData.push(a.audioBuffer.getChannelData(d))}if(typeof a.readyFunc==="function"){a.readyFunc()}},a.onError)};b.send()};JSPraat.Audio.prototype.recreateSourceNode=function(){this.sourceNode=this.ctx.createBufferSource();this.sourceNode.buffer=this.audioBuffer;console.log("sourceNode = ",this.sourceNode);this.connectNodes()};JSPraat.Audio.prototype.stopPlay=function(){if(this.playingTimeout){console.log("Audio: already playing something. Aborting current play:");window.clearTimeout(this.playingTimeout);this.playingTimeout=null;this.sourceNode.stop(0);this.recreateSourceNode()}};JSPraat.Audio.prototype.playDuration=function(d,c){var a=this;if(d<0||d>a.audioBuffer.duration){throw"Audio: playDuration requires 0 <= start <= duration"}var b=a.audioBuffer.duration-d;if(c){if(c>b){throw"Audio: playDuration requires duration <= remaining time"}}else{c=b}a.noteGrainOn(0,d,c)};JSPraat.Audio.prototype.playInterval=function(d,a){console.log("playing sound ["+d+", "+a+"]");var c,b=this;b.sourceNode.playbackRate.value=1;if(d<0||d>b.audioBuffer.duration){throw"Audio: playInterval requires 0 <= start <= duration"}if(a){if(a<d||a>b.audioBuffer.duration){throw"Audio: playInterval requires start <= end <= duration"}c=(a-d)}else{c=b.audioBuffer.duration-d}b.noteGrainOn(0,d,c)};JSPraat.Audio.prototype.noteGrainOn=function(b,d,c){var a=this;a.stopPlay();console.log(a.sourceNode);a.sourceNode.start(0,d,c);a.playingTimeout=window.setTimeout(function(){console.log("Audio: play finished. recreating source node.");a.recreateSourceNode();a.playingTimeout=null},1000*c);console.log("playingTimeout = ",a.playingTimeout)};JSPraat.Audio.prototype.onError=function(a){console.log(a);throw"Audio: error decoding audio data. "};JSPraat.TimeSyncedGrid=function(a){if(!(this instanceof JSPraat.TimeSyncedGrid)){return new JSPraat.TimeSyncedGrid(a)}if(!(a instanceof jQuery)){throw"TimeSyncedGrid: container must be a jQuery object"}if(a.length==0){throw"TimeSyncedGrid: container does not exist"}this.zoomFactor=20;this.xmultMin=100;this.xmultMax=800;this.xmult=this.xmultMin+(this.xmultMax-this.xmultMin)/2;this.timePrecision=3;this.cPrefix="TSG";this.currentTime=0;this.currentTimeMarkerPosition=null;this.tierNameOffset=null;this.c={width:null,height:null,"$":a,scroller:{cn:this.cPrefix+"-scroller","$":null,pos:0,audioWrapper:{cn:this.cPrefix+"-audio-wrapper","$":null,z:null,ctx:null,height:101},audioWrapper2:{cn:this.cPrefix+"-audio-wrapper2","$":null,z:null,ctx:null},textgridWrapper:{cn:this.cPrefix+"-textgrid-wrapper","$":null}},infotop:{cn:this.cPrefix+"-infotop","$":null,timeData:{cn:this.cPrefix+"-infotop-time-data","$":null},currentWindow:{cn:this.cPrefix+"-infotop-current-window","$":null},currentTime:{cn:this.cPrefix+"-current-time","$":null},controls:{cn:this.cPrefix+"-controls","$":null,zoomIn:{cn:this.cPrefix+"-controls-zoom-in","$":null},zoomOut:{cn:this.cPrefix+"-controls-zoom-out","$":null},zoomSlider:{cn:this.cPrefix+"-controls-zoom-slider","$":null},zoomIndicator:{cn:this.cPrefix+"-controls-zoom-indicator","$":null}}},label:{cn:this.cPrefix+"-label","$":null},tiers:{className:this.cPrefix+"-tier",s:"."+this.cPrefix+"-tier",floatersVisible:false,tierNameOffset:null,nfo:{}}};this.initializeUI();this.textgrid=null;this.audio=null};JSPraat.TimeSyncedGrid.prototype.initializeUI=function(){var a=this;this.c.$.html("<div class='"+this.c.scroller.cn+"'></div>");this.c.scroller.$=this.c.$.find("."+this.c.scroller.cn);this.c.$.prepend("<div class='"+this.c.label.cn+"'></div>");this.c.label.$=this.c.$.find("."+this.c.label.cn);this.c.$.prepend("<div class='"+this.c.infotop.cn+"'></div>");this.c.infotop.$=this.c.$.find("."+this.c.infotop.cn);this.c.infotop.$.prepend("<span class='"+this.c.infotop.currentWindow.cn+"'></span>");this.c.infotop.currentWindow.$=this.c.infotop.$.find("."+this.c.infotop.currentWindow.cn);this.c.infotop.currentWindow.$.attr("title","Current Time Window");this.c.infotop.currentWindow.$.text("-");this.c.infotop.$.prepend("<span class='"+this.c.infotop.timeData.cn+"'></span>");this.c.infotop.timeData.$=this.c.infotop.$.find("."+this.c.infotop.timeData.cn);this.c.infotop.$.append("<span class='"+this.c.infotop.currentTime.cn+"'></span>");this.c.infotop.currentTime.$=this.c.infotop.$.find("."+this.c.infotop.currentTime.cn);this.c.infotop.currentTime.$.text("-");this.c.infotop.$.prepend("<span class='"+this.c.infotop.controls.cn+"'></span>");this.c.infotop.controls.$=this.c.infotop.$.find("."+this.c.infotop.controls.cn);this.c.infotop.controls.$.append("<span class='control-btn "+this.c.infotop.controls.zoomIn.ID+"' data-name='zoomIn'><i class='fa fa-fw fa-search-plus'></i></span>");this.c.infotop.controls.zoomIn.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomIn.cn);this.c.infotop.controls.$.append("<span class='control-btn "+this.c.infotop.controls.zoomOut.ID+"' data-name='zoomOut'><i class='fa fa-fw fa-search-minus'></i></span>");this.c.infotop.controls.zoomOut.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomOut.cn);this.c.infotop.controls.$.append('<input type="range" name="points" min="'+this.xmultMin+'" max="'+this.xmultMax+'" class="'+this.c.infotop.controls.zoomSlider.cn+'">');this.c.infotop.controls.zoomSlider.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomSlider.cn);this.c.infotop.controls.zoomSlider.$.on("change",function(b){a.xmult=parseInt($(this).val());a.render()});this.c.infotop.controls.$.append('<span class="'+this.c.infotop.controls.zoomIndicator.cn+'">'+this.xmult+"</span>");this.c.infotop.controls.zoomIndicator.$=this.c.infotop.controls.$.find("."+this.c.infotop.controls.zoomIndicator.cn);this.c.scroller.$.append('<div class="'+this.c.scroller.textgridWrapper.cn+'"></div>');this.c.scroller.textgridWrapper.$=this.c.scroller.$.find("."+this.c.scroller.textgridWrapper.cn);this.c.scroller.$.prepend('<canvas class="'+this.c.scroller.audioWrapper.cn+'"></canvas>');this.c.scroller.audioWrapper.$=this.c.scroller.$.find("."+this.c.scroller.audioWrapper.cn);this.c.scroller.audioWrapper.z=this.c.scroller.audioWrapper.$.get(0);this.c.scroller.$.prepend('<canvas class="'+this.c.scroller.audioWrapper2.cn+'"></canvas>');this.c.scroller.audioWrapper2.$=this.c.scroller.$.find("."+this.c.scroller.audioWrapper2.cn);this.c.scroller.audioWrapper2.z=this.c.scroller.audioWrapper2.$.get(0);this.c.scroller.$.on("scroll",function(d){if(!a.tierNameOffset){return}var b=$(this).scrollLeft();var f=a.c.scroller.$.find(".tier-name-floater");if(b>=a.tierNameOffset&&!a.c.tiers.floatersVisible){f.stop(true,true).animate({opacity:1},200);a.c.tiers.floatersVisible=true}else{if(b<a.tierNameOffset&&a.c.tiers.floatersVisible){f.stop(true,true).animate({opacity:0},200);a.c.tiers.floatersVisible=false}}for(var c in a.c.tiers.nfo){a.c.tiers.nfo[c].nameFloater.transition().duration(700).attr("transform","translate("+b+", 0)")}if(a.audio){a.updateTimeMarkerAudio()}a.updateTimeWindow()});this.c.scroller.$.mousewheel(function(c,d){var b=a.c.scroller.$.scrollLeft();a.c.scroller.$.scrollLeft(b-10*d);a.updateTimeWindow();return false});this.c.infotop.controls.$.find(".control-btn").each(function(b){$(this).on("click",function(f){var c=$(this).data("name");var d=a["controlsEventHandler_"+c+"_click"];if(typeof d!=="function"){return}d.call(a,f)})});this.updateZoomControls()};JSPraat.TimeSyncedGrid.prototype.updateTimeWindow=function(){var a=this;var f=a.c.scroller.$;var d=a.c.infotop.currentWindow.$;var e=Math.round(a.mapTierPositionToTime(1)*1000)/1000;var c=a.c.scroller.$.width()-1;var b=Math.round(a.mapTierPositionToTime(c)*1000)/1000;a.c.scroller.audioWrapper.leftTime=e;a.c.scroller.audioWrapper.rightTime=b;a.c.scroller.audioWrapper.timeWindow=b-e;d.text(e+", "+b+", "+(Math.round((a.c.scroller.audioWrapper.timeWindow)*1000)/1000));if(a.audio){a.renderAudioWindow()}};JSPraat.TimeSyncedGrid.prototype.updateZoomControls=function(){var a=this;this.c.infotop.controls.zoomIndicator.$.text(Math.round((this.xmult-this.xmultMin)/(this.xmultMax-this.xmultMin)*100));this.c.infotop.controls.zoomSlider.$.val(this.xmult);var b=this.c.scroller.$.scrollLeft();window.setTimeout(function(){a.updateTimeWindow()},500)};JSPraat.TimeSyncedGrid.prototype.controlsEventHandler_zoomIn_click=function(a){console.log("TimeSyncedGrid Event: zoomIn");this.xmult+=this.zoomFactor;this.render()};JSPraat.TimeSyncedGrid.prototype.controlsEventHandler_zoomOut_click=function(b){console.log("TimeSyncedGrid Event: zoomOut");var a=this.xmult-this.zoomFactor;if(a<this.xmultMin){return}this.xmult=a;this.render()};JSPraat.TimeSyncedGrid.prototype.setTextGrid=function(a){this.textgrid=a;this.render()};JSPraat.TimeSyncedGrid.prototype.setAudio=function(a){this.audio=a;this.render()};JSPraat.TimeSyncedGrid.prototype.reshape=function(){console.log("reshaping...");var d=this;var f=0;var e=0;var c=0;for(var b in this.c.tiers.nfo){f=$(this.c.tiers.nfo[b].timeMarker[0][0]).offset().left;break}this.c.scroller.pos=this.c.scroller.$.scrollLeft();var a=d.c.tiers.tierNameOffset;d.c.scroller.$.find("svg").each(function(k){var l=$(this).height();var j=l/2;var i=j/4;var h=d3.select(this).data()[0];var g=h.isIntervalTier();$(this).find("g").each(function(n){var m=$(this);var o=d3.select(this).data();if(typeof o[0][0]==="undefined"){return}o=o[0];m.attr("transform","translate("+(a+d.xmult*o[0])+", "+(i)+")");if(g){m.find("rect").attr("width",(d.xmult*o[1])-(d.xmult*o[0])-1).attr("height",j)}})});this.updateZoomControls();this.updateTimeMarker();e=$(this.c.tiers.nfo[Object.keys(this.c.tiers.nfo)[0]].timeMarker[0][0]).offset().left;c=e-f;if(f){this.c.scroller.$.scrollLeft(this.c.scroller.pos+c)}};JSPraat.TimeSyncedGrid.prototype.render=function(){var c=this;this.c.width=this.c.$.innerWidth();this.c.height=this.c.$.innerHeight();var e=0;var d=0;var b=0;for(var a in this.c.tiers.nfo){e=$(this.c.tiers.nfo[a].timeMarker[0][0]).offset().left;break}this.c.scroller.pos=this.c.scroller.$.scrollLeft();if(this.textgrid){this.renderTextGrid()}if(this.audio){this.c.scroller.audioWrapper.$.show();this.c.scroller.audioWrapper2.$.show();this.renderAudio()}else{this.c.scroller.audioWrapper.$.hide();this.c.scroller.audioWrapper2.$.hide()}this.c.scroller.$.scrollLeft(this.c.scroller.pos);this.updateZoomControls();this.updateTimeMarker();d=$(this.c.tiers.nfo[Object.keys(this.c.tiers.nfo)[0]].timeMarker[0][0]).offset().left;b=d-e;if(e){this.c.scroller.$.scrollLeft(this.c.scroller.pos+b)}$(window).on("resize",function(f){c.onWindowResize.apply(c,f)})};JSPraat.TimeSyncedGrid.prototype.renderTextGrid=function(){console.log("rendering textgrid");var q=this;var l=Math.ceil(q.textgrid.header.xmax);var p=null;if(this.textgrid===null){throw"TimeSyncedGrid: renderTextGrid found no textgrid"}this.xmin=this.textgrid.header.xmin;this.xmax=this.textgrid.header.xmax;this.c.scroller.textgridWrapper.$.html("");var n=d3.select(this.c.scroller.textgridWrapper.$.get(0)).selectAll("div").data(this.textgrid.tiers).enter().append("div").attr("class",function(i){return q.c.tiers.className+" "+(i.isIntervalTier()?"interval-tier":"point-tier")}).attr("data-height",function(i){return $(this).height()}).append("svg").attr("height",function(){return(p=$(this).parent().height())}).attr("width",function(){return q.xmult*l});var j=p/2;var k=n[0];var h=0;for(var d=0;d<k.length;d++){var a=k[d].__data__.header.name;if(a.length>h){h=a.length}}h*=10;q.c.tiers.tierNameOffset=h;for(var d=0;d<k.length;d++){var g=k[d];var c=g.__data__;var f=d3.select(g);var m=f.append("rect").attr("height",j).attr("width",h).attr("x",0).attr("y",j/2).attr("class","tier-name-box").attr("title",c.header.name);var e=f.append("text").attr("height",j).attr("width",h).attr("x",0).attr("y",j/2).attr("dy",j/1.5).attr("dx",2).attr("class","tier-name-text").text(c.header.name);var b=null;if(c.isIntervalTier()){b=f.selectAll("g").data(c.intervals).enter().append("g").attr("transform",function(s,r){return"translate("+(h+q.xmult*s[0])+", "+(j/2)+")"}).attr("width",function(i){return(q.xmult*i[1])-(q.xmult*i[0])-1}).attr("height",j).attr("class","interval-group").on("mouseenter",function(i){q.c.infotop.timeData.$.text(i[0].toFixed(q.timePrecision)+", "+i[1].toFixed(q.timePrecision));q.c.label.$.html(i[2])}).on("mouseout",function(i){}).on("click",function(i){if(q.audio){q.audio.playInterval(i[0],i[1])}});b.append("rect").attr("height",j).attr("width",function(i){return(q.xmult*i[1])-(q.xmult*i[0])-1}).attr("x",0).attr("y",0).attr("class","interval-box").attr("title",function(i){return i[2]});b.append("text").attr("x",0).attr("y",0).attr("dy",j/1.5).attr("dx",2).text(function(i){var r=$(this).prev();if((i[2].length*10)>=parseInt(r.attr("width"))){r.attr("class","interval-box-too-small");return""}return i[2]}).attr("class","tier-text")}if(c.isPointTier()){b=f.selectAll("g").data(c.points).enter().append("g").attr("transform",function(s,r){return"translate("+(h+q.xmult*s[0])+", "+(j/2)+")"}).attr("width",5).attr("height",j).attr("class","point-group").on("mouseenter",function(i){q.c.infotop.timeData.$.text(i[0].toFixed(q.timePrecision));q.c.label.$.text(i[1])}).on("mouseout",function(i){});b.append("rect").attr("height",j).attr("width",function(i){return 10*i[1].length}).attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("class","point-box");b.append("text").attr("x",0).attr("y",0).attr("dy",j/1.5).attr("dx",2).text(function(i){var r=$(this).prev();if((i[1].length*10)>parseInt(r.attr("width"))){r.attr("class","interval-box-too-small");return""}return i[1]}).attr("class","tier-text")}var o=f.append("rect").attr("width",1).attr("height",p).attr("x",q.currentTimeMarkerPosition).attr("y",0).attr("class","current-time-marker");tierFloaterGroup=f.append("g").attr("transform","translate("+0+","+0+")").attr("width",h).attr("height",j/2).attr("class","tier-name-floater");tierFloaterGroup.append("rect").attr("width",h).attr("height",j/2);tierFloaterGroup.append("text").attr("x",0).attr("y",0).attr("dy",j/2.5).attr("dx",2).attr("class","tier-name-floater-text").text(c.header.name);f.attr("data-tier-name",c.header.name);q.c.tiers.nfo[c.header.name]={timeMarker:o,nameFloater:tierFloaterGroup}}q.c.tiers.tierNameOffset=h;q.c.scroller.$.find("svg").on("click",function(i){q.currentTime=q.mapTierPositionToTime(i.pageX-q.c.scroller.$.position().left);q.updateTimeMarker()});q.tierNameOffset=h};JSPraat.TimeSyncedGrid.prototype.mapTierPositionToTime=function(d){var b=this;var a=b.c.tiers.tierNameOffset;var c=b.c.scroller.$.scrollLeft()-a-1;if(d){c+=d}if(c<0){c=0}return c/b.xmult};JSPraat.TimeSyncedGrid.prototype.updateTimeMarker=function(){var b=this;b.currentTimeMarkerPosition=b.currentTime*b.xmult+b.c.tiers.tierNameOffset;for(var a in b.c.tiers.nfo){var c=b.c.tiers.nfo[a].timeMarker;c.attr("x",b.currentTimeMarkerPosition)}this.c.infotop.currentTime.$.text(this.currentTime.toFixed(this.timePrecision));if(b.audio){b.updateTimeMarkerAudio()}};JSPraat.TimeSyncedGrid.prototype.updateTimeMarkerAudio=function(){var d=this;var c=d.c.scroller.audioWrapper2.ctx;if(!c){return}var g=d.c.scroller.$.scrollLeft();var e=d.c.scroller.audioWrapper.z.width;var b=d.c.scroller.audioWrapper.z.height;var f=d.c.scroller.audioWrapper2.z.width;var a=(d.currentTimeMarkerPosition+0.5-g)%f;c.clearRect(0,0,e,b);c.beginPath();c.moveTo(a,0);c.lineTo(a,parseInt(d.c.scroller.audioWrapper.z.height));c.strokeStyle="rgba(255,0,0,0.5)";c.lineWidth=1.5;c.stroke()};JSPraat.TimeSyncedGrid.prototype.onWindowResize=function(){var b=this;if(b.audio){var a=b.c.scroller.audioWrapper.height;b.c.scroller.audioWrapper2.$.width(b.c.scroller.$.width());b.c.scroller.audioWrapper2.z.width=b.c.scroller.$.width();b.c.scroller.audioWrapper2.$.height(a);b.c.scroller.audioWrapper2.z.height=a}};JSPraat.TimeSyncedGrid.prototype.renderAudio=function(){console.log("rendering Audio");var j=this;if(j.audio===null){throw"TimeSyncedGrid: renderAudio found no audio"}var c=this.c.tiers.tierNameOffset;var b=j.audio.audioBuffer.duration;console.log("duration = ",b);var f=b*j.xmult;var a=c+f;var i=j.c.scroller.audioWrapper.height;var e=i/2;j.c.scroller.audioWrapper.$.width(j.c.scroller.$.width());j.c.scroller.audioWrapper.z.width=j.c.scroller.$.width();j.c.scroller.audioWrapper.z.style.position="relative";j.c.scroller.audioWrapper.z.style.left="0px";j.c.scroller.audioWrapper.$.height(i);j.c.scroller.audioWrapper.z.height=i;var d=j.c.scroller.audioWrapper.$.position();j.c.scroller.audioWrapper2.z.style.position="absolute";j.c.scroller.audioWrapper2.z.style.top=d.top;j.c.scroller.audioWrapper2.z.style.left=d.left;j.c.scroller.audioWrapper2.$.width(j.c.scroller.$.width());j.c.scroller.audioWrapper2.z.width=j.c.scroller.$.width();j.c.scroller.audioWrapper2.$.height(i);j.c.scroller.audioWrapper2.z.height=i;var h=f;var g=j.audio.findPeaks(h);j.c.scroller.audioWrapper.peaks=g;console.log("peaks.length = ",g.length);j.updateTimeWindow();j.c.scroller.audioWrapper2.ctx=j.c.scroller.audioWrapper2.z.getContext("2d")};JSPraat.TimeSyncedGrid.prototype.renderAudioWindow=function(){var o=this;var f=this.c.tiers.tierNameOffset;var m=o.c.scroller.audioWrapper.height;var g=m/2;var k=o.c.scroller.audioWrapper.peaks;var p=o.c.scroller.audioWrapper.z.getContext("2d");var c=o.audio.audioBuffer.duration;var a=o.c.scroller.audioWrapper.leftTime;var l=o.c.scroller.audioWrapper.rightTime;var j=~~((a/c)*k.length);var h=~~((l/c)*k.length);var b=o.c.scroller.$.scrollLeft();o.c.scroller.audioWrapper.z.style.left=o.c.scroller.$.scrollLeft()+"px";var d=0;if(b<f){d=-b}else{d=-f}o.c.scroller.audioWrapper.z.width=o.c.scroller.audioWrapper.z.width;var n=null;p.beginPath();for(var e=j;e<h;++e){n=g*k[e];p.moveTo(f+d,g);p.lineTo(f+d,g+n);p.moveTo(f+d,g);p.lineTo(f+d,g-n);++d}p.strokeStyle="rgba(0,0,100,0.7)";p.lineWidth=1;p.stroke();o.c.scroller.audioWrapper.ctx=p};JSPraat.TimeSyncedGrid.autoRender=function(){$(".TSG-container").each(function(g){var f=$(this);var b=f.data("textgrid");var h=f.data("audio");console.log(b);var a=new JSPraat.TimeSyncedGrid(f);console.log("autoRender: TextGrid URL = ",b);if(b){console.log("autoRender: creating TextGrid");var d=new JSPraat.TextGrid(b,function(){a.setTextGrid(this)})}console.log("autoRender: Audio URL = ",h);if(h&&!h.match(/^\s+$/)){console.log("autoRender: creating Audio");var c=new JSPraat.Audio(h,function(){console.log("READY!");a.setAudio(this)})}})};