var JSPraat={};JSPraat.TextGrid={};JSPraat.TextGrid.Tier=function(a){if(!(this instanceof JSPraat.TextGrid.Tier)){return new JSPraat.TextGrid.Tier(a)}this.lines=a;this.lines.pop();this.header={classname:null,name:null,xmin:null,xmax:null,numberOfIntervals:null,numberOfPoints:null};this.startingLineIndexOfBody=null;this.parseHeader();this.checkHeader();if(this.header.classname==="IntervalTier"){this.intervals=[];this.parseIntervals()}else{if(this.header.classname==="TextTier"){this.points=[];this.parsePoints()}else{throw"Invalid Tier Header: "+this.header.classname+" is not an acceptable classname"}}};JSPraat.TextGrid.Tier.prototype.checkHeader=function(){if(!this.header.classname){throw"Invalid Tier Header: classname is missing"}if(!this.header.name){throw"Invalid Tier Header: name is missing"}if(!this.header.xmin){throw"Invalid Tier Header: xmin is missing"}if(!this.header.xmax){throw"Invalid Tier Header: xmax is missing"}if(this.header.numberOfIntervals===null&&this.header.numberOfPoints===null){throw"Invalid Tier Header: not an interval or point tier."}if(this.isIntervalTier()&&this.header.numberOfIntervals===null){throw"Invalid Tier Header: classname mismatch. says interval tier but has points size"}if(this.isPointTier()&&this.header.numberOfPoints===null){throw"Invalid Tier Header: classname mismatch. says point tier but has intervals size"}if(this.header.numberOfPoints!==null&&this.header.numberOfIntervals!==null){throw"Invalid Tier Header: header cannot contain both points size and intervals size"}};JSPraat.TextGrid.Tier.prototype.isIntervalTier=function(){if(this.header.classname==="IntervalTier"){return true}return false};JSPraat.TextGrid.Tier.prototype.isPointTier=function(){if(this.header.classname==="TextTier"){return true}return false};JSPraat.TextGrid.Tier.prototype.parseHeader=function(){var a=/^\s+class\s*=\s*\"(\w+)\"/i;var h=/^\s+name\s*=\s*\"(\w+)\"/i;var g=/^\s+xmin\s*=\s*([\d\.]+)/i;var d=/^\s+xmax\s*=\s*([\d\.]+)/i;var b=/^\s+intervals\:\s*size\s*=\s*(\d+)/i;var f=/^\s+points\:\s*size\s*=\s*(\d+)/i;var j=/^(\s+)/;var e;var k=false;var l=null;for(var c=0;c<this.lines.length;c++){if((e=this.lines[c].match(b))){this.header.numberOfIntervals=l=parseInt(e[1]);k=true;this.startingLineIndexOfBody=c+1;break}if((e=this.lines[c].match(f))){this.header.numberOfPoints=l=parseInt(e[1]);k=true;this.startingLineIndexOfBody=c+1;break}else{if((e=this.lines[c].match(a))){this.header.classname=e[1]}else{if((e=this.lines[c].match(h))){this.header.name=e[1]}else{if((e=this.lines[c].match(g))){this.header.xmin=e[1]}else{if((e=this.lines[c].match(d))){this.header.xmax=e[1]}}}}}}if(!k&&l>0){throw"Invalid Tier Header: end condition not reached while size is non-zero"}};JSPraat.TextGrid.Tier.prototype.parseIntervals=function(){if(this.header.numberOfIntervals===0){return}var d=this.startingLineIndexOfBody;var b,a,e,j;var h=/^\s*intervals\s*\[\d+\]\:/i;var f=/^\s*xmax\s*\=\s*([\d\.]+)/i;var g=/^\s*xmin\s*\=\s*([\d\.]+)/i;var c=/^\s*text\s*\=\s*\"(.*)\"/i;while(d<this.lines.length){b=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 0"}a=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 1"}e=this.lines[d++];if(d>=this.lines.length){throw"Invalid Tier Body: incomplete interval 2"}j=this.lines[d++];if((match=b.match(h))){}else{throw"Invalid Tier Body: Invalid interval start format, expecting 'intervals [<digit>]:'"}if((match=e.match(f))){e=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'xmax' format"}if((match=a.match(g))){a=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'xmin' format"}if((match=j.match(c))){j=match[1]}else{throw"Invalid Tier Body: Invalid 'text' format"}this.intervals.push([a,e,j])}if(d<this.lines.length){throw"Invalid Tier Body: incomplete interval remains"}};JSPraat.TextGrid.Tier.prototype.parsePoints=function(){if(this.header.numberOfPoints===0){return}var f=/\s*points\s*\[\d+\]\:/i;var e=/^\s*number\s*\=\s*([\d\.]+)/i;var d=/^\s*mark\s*\=\s*\"(.*)\"/i;var b,c,g;for(var a=this.startingLineIndexOfBody;a<this.lines.length;a++){b=this.lines[a++];if(a>=this.lines.length){throw"Invalid Tier Body: incomplete point 0"}c=this.lines[a++];if(a>=this.lines.length){throw"Invalid Tier Body: incomplete point 1"}g=this.lines[a++];if((match=b.match(f))){}else{throw"Invalid Tier Body: Invalid point start format, expecting 'points [<digit>]:'"}if((match=c.match(e))){c=parseFloat(match[1])}else{throw"Invalid Tier Body: Invalid 'number' format"}if((match=g.match(d))){g=match[1]}else{throw"Invalid Tier Body: Invalid 'mark' format"}this.points.push([c,g])}};JSPraat.TextGrid.TextGrid=function(d){if(!(this instanceof JSPraat.TextGrid.TextGrid)){return new JSPraat.TextGrid.TextGrid(d)}var c=/^.+\.TextGrid$/i;var b;var a=this;this.readyFunc=null;if((b=d.match(c))){$.ajax({url:d}).done(function(e){a.initializeFromData(e)})}else{this.initializeFromData(d)}};JSPraat.TextGrid.TextGrid.prototype.initializeFromData=function initializeFromData(a){this.lines=a.split("\n");this.header={fileType:null,objectClass:null,xmin:null,xmax:null,tiersExist:false,numberOfTiers:0};this.startingLineIndexOfTiers=-1;this.tiers=[];this.parseHeader();this.checkHeader();this.parseTiers();if(typeof this.readyFunc==="function"){this.readyFunc()}};JSPraat.TextGrid.TextGrid.prototype.ready=function(a){if(typeof a!=="function"){throw"TextGrid ready requires a function"}this.readyFunc=a};JSPraat.TextGrid.TextGrid.prototype.checkHeader=function(){if(this.tiersExist===false){throw"Invalid TextGrid Header: Tiers do not exist"}if(this.startingLineIndexOfTiers<0){throw"Invalid TextGrid Header: startingLineIndexOfTiers Not Found"}};JSPraat.TextGrid.TextGrid.prototype.parseTiers=function(){var b=/^\s+item\s+\[(\d+)\]\:/i;var a;var d=null;var f=0;var e=0;for(var c=this.startingLineIndexOfTiers;c<this.lines.length;c++){if((a=this.lines[c].match(b))){if(d>0){this.tiers.push(new JSPraat.TextGrid.Tier(this.lines.slice(f,e)))}d=parseInt(a[1]);f=c+1;e=c+1}if(d>0){e++}}this.tiers.push(new JSPraat.TextGrid.Tier(this.lines.slice(f,e)))};JSPraat.TextGrid.TextGrid.prototype.parseHeader=function(){var g=/^\s*item\s*\[.+\]\:/i;var j=/^xmin\s*=\s*([\d\.]+)/i;var e=/^xmax\s*=\s*([\d\.]+)/i;var h=/^tiers\?\s*(<exists>)/i;var a=/^size\s*=\s*(\d+)/;var c=/^File type\s*=\s*\"(\w+)\"/i;var b=/^Object class\s*=\s*\"(\w+)\"/i;var f;for(var d=0;d<this.lines.length;d++){if(this.lines[d].match(g)){this.startingLineIndexOfTiers=d;break}if((f=this.lines[d].match(j))){this.header.xmin=parseFloat(f[1])}else{if((f=this.lines[d].match(e))){this.header.xmax=parseFloat(f[1])}else{if((f=this.lines[d].match(h))){this.header.tiersExist=true}else{if((f=this.lines[d].match(a))){this.header.numberOfTiers=parseInt(f[1])}else{if((f=this.lines[d].match(c))){this.header.fileType=f[1]}else{if((f=this.lines[d].match(b))){this.header.objectClass=f[1]}}}}}}}};JSPraat.TimeSyncedGrid={};JSPraat.TimeSyncedGrid.TimeSyncedGrid=function(a){if(!(this instanceof JSPraat.TimeSyncedGrid.TimeSyncedGrid)){return new JSPraat.TimeSyncedGrid.TimeSyncedGrid(a)}if($("#"+a).length==0){throw"TimeSyncedGrid: container id='"+a+"' does not exist"}this.zoomFactor=5;this.xmultMin=100;this.xmultMax=400;this.xmult=this.xmultMax;this.timePrecision=3;this.cPrefix="TSG";this.currentTime=0;this.c={ID:a,width:null,height:null,"$":$("#"+a),scroller:{ID:this.cPrefix+"-scroller","$":null,pos:0},infotop:{ID:this.cPrefix+"-infotop",s:null,"$":null,label:{ID:this.cPrefix+"-infotop-label",s:null,"$":null},currentTime:{ID:this.cPrefix+"-current-time",s:null,"$":null},controls:{ID:this.cPrefix+"-controls",s:"."+this.cPrefix+"-controls","$":null,zoomIn:{ID:this.cPrefix+"-controls-zoom-in",s:"#"+this.cPrefix+"-controls-zoom-in","$":null},zoomOut:{ID:this.cPrefix+"-controls-zoom-out",s:"#"+this.cPrefix+"-controls-zoom-out","$":null},zoomSlider:{ID:this.cPrefix+"-controls-zoom-slider",s:"#"+this.cPrefix+"-controls-zoom-slider","$":null},zoomIndicator:{ID:this.cPrefix+"-controls-zoom-indicator",s:"#"+this.cPrefix+"-controls-zoom-indicator","$":null}}},tiers:{className:this.cPrefix+"-tier",s:"."+this.cPrefix+"-tier",nfo:{}}};this.initializeUI();this.textgrid=null;this.wav=null};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.initializeUI=function(){var a=this;this.c.$.html("<div id='"+this.c.scroller.ID+"'></div>");this.c.scroller.s="#"+this.c.scroller.ID;this.c.scroller.$=$(this.c.scroller.s);this.c.$.prepend("<div id='"+this.c.infotop.ID+"'></div>");this.c.infotop.s="#"+this.c.infotop.ID;this.c.infotop.$=$(this.c.infotop.s);this.c.infotop.$.prepend("<span id='"+this.c.infotop.label.ID+"'></span>");this.c.infotop.label.s="#"+this.c.infotop.label.ID;this.c.infotop.label.$=$(this.c.infotop.label.s);this.c.infotop.$.append("<span id='"+this.c.infotop.currentTime.ID+"'></span>");this.c.infotop.currentTime.s="#"+this.c.infotop.currentTime.ID;this.c.infotop.currentTime.$=$(this.c.infotop.currentTime.s);this.c.infotop.currentTime.$.text("-");this.c.infotop.$.prepend("<span id='"+this.c.infotop.controls.ID+"'></span>");this.c.infotop.controls.s="#"+this.c.infotop.controls.ID;this.c.infotop.controls.$=$(this.c.infotop.controls.s);this.c.infotop.controls.$.append("<span id='"+this.c.infotop.controls.zoomIn.ID+"' class='control-btn' data-name='zoomIn'><i class='fa fa-fw fa-search-plus'></i></span>");this.c.infotop.controls.zoomIn.$=$(this.c.infotop.controls.zoomIn.s);this.c.infotop.controls.$.append("<span id='"+this.c.infotop.controls.zoomOut.ID+"' class='control-btn' data-name='zoomOut'><i class='fa fa-fw fa-search-minus'></i></span>");this.c.infotop.controls.zoomOut.$=$(this.c.infotop.controls.zoomOut.s);this.c.infotop.controls.$.append('<input type="range" name="points" min="'+this.xmultMin+'" max="'+this.xmultMax+'" id="'+this.c.infotop.controls.zoomSlider.ID+'">');this.c.infotop.controls.zoomSlider.$=$(this.c.infotop.controls.zoomSlider.s);this.c.infotop.controls.zoomSlider.$.on("change",function(b){a.xmult=$(this).val();a.render()});this.c.infotop.controls.$.append('<span id="'+this.c.infotop.controls.zoomIndicator.ID+'">'+this.xmult+"</span>");this.c.infotop.controls.zoomIndicator.$=$(this.c.infotop.controls.zoomIndicator.s);this.c.infotop.controls.$.find(".control-btn").each(function(b){$(this).on("click",function(f){var c=$(this).data("name");var d=a["controlsEventHandler_"+c+"_click"];if(typeof d!=="function"){return}d.call(a,f)})});this.updateZoomControls()};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.updateZoomControls=function(){console.log("updating zoom controls "+this.xmult);this.c.infotop.controls.zoomIndicator.$.text(Math.round((this.xmult-this.xmultMin)/(this.xmultMax-this.xmultMin)*100));this.c.infotop.controls.zoomSlider.$.val(this.xmult)};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.controlsEventHandler_zoomIn_click=function(a){console.log("TimeSyncedGrid Event: zoomIn");this.xmult+=1+this.zoomFactor;this.render()};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.controlsEventHandler_zoomOut_click=function(b){console.log("TimeSyncedGrid Event: zoomOut");var a=this.xmult-this.zoomFactor;if(a<this.xmultMin){return}this.xmult=a;this.render()};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.setTextGrid=function(a){this.textgrid=a;this.render()};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.render=function(){this.c.width=this.c.$.innerWidth();this.c.height=this.c.$.innerHeight();this.c.scroller.pos=this.c.scroller.$.scrollLeft();console.log(this.c.scroller.pos);this.c.scroller.$.html("");this.updateZoomControls();if(this.wav){this.renderWAV()}if(this.textgrid){this.renderTextGrid()}this.c.scroller.$.scrollLeft(this.c.scroller.pos);this.updateTimeMarker()};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.renderTextGrid=function(){var o=this;var k=Math.ceil(o.textgrid.header.xmax);var n=null;if(this.textgrid===null){throw"TimeSyncedGrid: renderTextGrid found no textgrid"}console.log("rendering textgrid");this.xmin=this.textgrid.header.xmin;this.xmax=this.textgrid.header.xmax;var l=d3.select(this.c.scroller.s).selectAll("div").data(this.textgrid.tiers).enter().append("div").attr("class",function(i){return o.c.tiers.className+" "+(i.isIntervalTier()?"interval-tier":"point-tier")}).attr("data-height",function(i){return $(this).height()}).append("svg").attr("height",function(){return(n=$(this).parent().height())}).attr("width",function(){return o.xmult*k});var h=n/2;var j=l[0];var g=0;for(var d=0;d<j.length;d++){var a=j[d].__data__.header.name;if(a.length>g){g=a.length}}g*=10;for(var d=0;d<j.length;d++){var f=j[d];var c=f.__data__;var e=d3.select(f);if(c.isIntervalTier()){e.append("rect").attr("height",h).attr("width",g).attr("x",0).attr("y",h/2).attr("class","tier-name-box interval-tier-name-box").attr("title",c.header.name);e.append("text").attr("height",h).attr("width",g).attr("x",0).attr("y",h/2).attr("dy",h/1.5).attr("dx",2).attr("class","tier-name-text interval-tier-name-text").text(c.header.name);var b=e.selectAll("g").data(c.intervals).enter().append("g").attr("transform",function(q,p){return"translate("+(g+o.xmult*q[0])+", "+(h/2)+")"}).attr("width",function(i){return(o.xmult*i[1])-(o.xmult*i[0])-1}).attr("height",h).attr("class","interval-group").on("mouseenter",function(i){o.c.infotop.label.$.html("["+i[0].toFixed(o.timePrecision)+", "+i[1].toFixed(o.timePrecision)+"] &nbsp;"+i[2])}).on("mouseout",function(i){});b.append("rect").attr("height",h).attr("width",function(i){return(o.xmult*i[1])-(o.xmult*i[0])-1}).attr("x",0).attr("y",0).attr("class","interval-box").attr("title",function(i){return i[2]});b.append("text").attr("x",0).attr("y",0).attr("dy",h/1.5).attr("dx",2).text(function(i){var p=$(this).prev();if((i[2].length*10)>=parseInt(p.attr("width"))){p.attr("class","interval-box-too-small");return""}return i[2]}).attr("class","tier-text")}if(c.isPointTier()){e.append("rect").attr("height",h).attr("width",g).attr("x",0).attr("y",h/2).attr("class","tier-name-box point-tier-name-box").attr("title",c.header.name);e.append("text").attr("height",h).attr("width",g).attr("x",0).attr("y",h/2).attr("dy",h/1.5).attr("dx",2).attr("class","tier-name-text point-tier-name-text").text(c.header.name);var b=e.selectAll("g").data(c.points).enter().append("g").attr("transform",function(q,p){return"translate("+(g+o.xmult*q[0])+", "+(h/2)+")"}).attr("width",5).attr("height",h).attr("class","point-group").on("mouseenter",function(i){o.c.infotop.label.$.text(i[0].toFixed(o.timePrecision)+": "+i[1])}).on("mouseout",function(i){});b.append("rect").attr("height",h).attr("width",function(i){return 10*i[1].length}).attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("class","point-box");b.append("text").attr("x",0).attr("y",0).attr("dy",h/1.5).attr("dx",2).text(function(i){var p=$(this).prev();if((i[1].length*10)>parseInt(p.attr("width"))){p.attr("class","interval-box-too-small");return""}return i[1]}).attr("class","tier-text")}var m=e.append("rect").attr("width",1).attr("height",n).attr("x",this.currentTime*this.xmult).attr("y",0).attr("class","current-time-marker");e.attr("data-tier-name",c.header.name);o.c.tiers.nfo[c.header.name]={timeMarker:m}}o.c.tiers.tierNameOffset=g;o.c.scroller.$.find("svg").on("click",function(p){var i=o.c.scroller.$.scrollLeft()+(p.pageX-o.c.scroller.$.position().left)-g-1;if(i<0){i=0}o.currentTime=i/o.xmult;console.log(i,o.currentTime);o.c.infotop.currentTime.$.text(o.currentTime.toFixed(o.timePrecision));o.updateTimeMarker()})};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.renderWAV=function(){};JSPraat.TimeSyncedGrid.TimeSyncedGrid.prototype.updateTimeMarker=function(){var b=this;for(var a in b.c.tiers.nfo){var c=b.c.tiers.nfo[a].timeMarker;c.attr("x",b.currentTime*b.xmult+b.c.tiers.tierNameOffset)}this.c.infotop.currentTime.$.text(this.currentTime.toFixed(this.timePrecision))};